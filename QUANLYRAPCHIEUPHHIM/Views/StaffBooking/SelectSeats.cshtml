@{
    ViewData["Title"] = "Chọn ghế - Đặt vé";
    Layout = "_Layout";
}

<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="mb-0">Chọn ghế</h4>
                <a asp-controller="StaffBooking" asp-action="SelectShowtime" asp-route-movieId="@ViewBag.Showtime?.Movie?.MovieId" class="btn btn-sm btn-light">
                    <i class="fas fa-arrow-left"></i> Quay lại
                </a>
            </div>
        </div>
        <div class="card-body">
            <!-- Thông tin suất chiếu -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="alert alert-info">
                        <h5>Thông tin suất chiếu</h5>
                        @if (ViewBag.Showtime != null)
                        {
                            <p class="mb-1"><strong>Phim:</strong> @ViewBag.Showtime.Movie?.Title</p>
                            <p class="mb-1"><strong>Rạp:</strong> @ViewBag.Showtime.Room?.Cinema?.Name - @ViewBag.Showtime.Room?.Name</p>
                            <p class="mb-1"><strong>Suất chiếu:</strong> @ViewBag.Showtime.StartTime.ToString("dd/MM/yyyy - HH:mm")</p>
                            <p class="mb-0"><strong>Định dạng:</strong> @ViewBag.Showtime.Room?.Format?.Name</p>
                        }
                        else
                        {
                            <p class="text-danger">Không có thông tin suất chiếu. Vui lòng quay lại và chọn lại suất chiếu.</p>
                        }
                    </div>
                </div>
            </div>

            <!-- Màn hình -->
            <div class="text-center mb-4">
                <div class="screen">MÀN HÌNH</div>
                <p class="text-muted small mt-2">Hàng ghế đầu tiên cách màn hình 4 mét</p>
            </div>

            <!-- Sơ đồ ghế -->
            <div class="seat-map text-center mb-4">
                <!-- Ký hiệu ghế -->
                <div class="seat-legend mb-3">
                    <span class="seat-type"><i class="fas fa-square text-success"></i> Ghế trống</span>
                    <span class="seat-type"><i class="fas fa-square text-danger"></i> Ghế đã đặt</span>
                    <span class="seat-type"><i class="fas fa-square text-warning"></i> Ghế đang chọn</span>
                    <span class="seat-type"><i class="fas fa-square text-primary"></i> Ghế VIP</span>
                    <span class="seat-type"><i class="fas fa-square text-info"></i> Ghế đôi</span>
                </div>

                <!-- Các hàng ghế -->
                <div class="seat-container">
                    @{
                        var seats = ViewBag.RoomSeats as List<Seat>;
                        var bookedSeats = ViewBag.BookedSeats as List<int>;
                        var grouped = seats?.OrderBy(s => s.RowLetter).ThenBy(s => s.SeatNumber)
                            .GroupBy(s => s.RowLetter);
                    }
                    @if (grouped != null)
                    {
                        foreach (var row in grouped)
                        {
                            <div class="seat-row">
                                <div class="row-label">@row.Key</div>
                                <div class="seats">
                                    @foreach (var seat in row)
                                    {
                                        var isBooked = bookedSeats?.Contains(seat.SeatId) ?? false;
                                        var seatClass = "seat available";
                                        if (isBooked) seatClass = "seat booked";
                                        if (seat.SeatType?.TypeName.Contains("VIP") == true) seatClass += " vip";
                                        if (seat.SeatType?.TypeName.Contains("Đôi") == true) seatClass += " couple";
                                        <div class="@seatClass" data-seat-id="@seat.SeatId" data-seat-position="@(seat.RowLetter + seat.SeatNumber)">
                                            @(seat.RowLetter + seat.SeatNumber)
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>

            <!-- Thông tin đặt chỗ -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Thông tin đặt ghế</h5>
                        </div>
                        <div class="card-body">
                            <p><strong>Ghế đã chọn:</strong>
                                <span id="selectedSeats">Chưa chọn ghế</span>
                                <button id="clearSeats" class="btn btn-sm btn-outline-danger ms-2" style="display:none;">Xóa tất cả</button>
                            </p>
                            <ul id="selectedSeatList" class="list-inline"></ul>
                            <p><strong>Số lượng:</strong> <span id="seatCount">0</span></p>
                            <p><strong>Tổng tiền:</strong> <span id="totalPrice">0</span> VND</p>
                            <button id="btnContinue" class="btn btn-primary" disabled>Tiếp tục</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Bảng giá</h5>
                        </div>
                        <div class="card-body">
                            <p><strong>Ghế thường:</strong> @ViewBag.BasePrice.ToString("N0") VND</p>
                            <p><strong>Ghế VIP:</strong> @((ViewBag.BasePrice + 30000).ToString("N0")) VND</p>
                            <p><strong>Ghế đôi:</strong> @((ViewBag.BasePrice * 2).ToString("N0")) VND</p>
                            <p class="text-muted small">Giá vé có thể thay đổi theo từng suất chiếu</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .screen {
            background: #ccc;
            height: 30px;
            border-radius: 5px;
            margin: 0 30px;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        
        .seat-legend {
            margin-top: 20px;
        }
        
        .seat-type {
            margin-right: 15px;
        }
        
        .seat-container {
            margin-top: 20px;
        }
        
        .seat-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .row-label {
            width: 30px;
            text-align: center;
            font-weight: bold;
        }
        
        .seats {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .seat {
            width: 35px;
            height: 35px;
            margin: 3px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .seat.available {
            background-color: #4CAF50;
            color: white;
        }
        
        .seat.booked {
            background-color: #F44336;
            color: white;
            cursor: not-allowed;
        }
        
        .seat.selected {
            background-color: #FFC107;
            color: black;
        }
        
        .seat.vip {
            background-color: #2196F3;
            color: white;
        }
        
        .seat.couple {
            width: 75px;
            background-color: #00BCD4;
            color: white;
        }
        
        .seat:hover:not(.booked) {
            transform: scale(1.1);
        }
    </style>
}

@section Scripts {
    <script>
        $(document).ready(function() {
            const regularPrice = @(ViewBag.BasePrice ?? 0);
            const vipPrice = @((ViewBag.BasePrice ?? 0) + 30000);
            const couplePrice = @((ViewBag.BasePrice ?? 0) * 2);
            let selectedSeats = [];
            
            // Xử lý chọn ghế
            $('.seat.available').click(function() {
                let seatId = $(this).data('seat-id');
                let seatPosition = $(this).data('seat-position');
                
                if ($(this).hasClass('selected')) {
                    // Bỏ chọn ghế
                    $(this).removeClass('selected');
                    selectedSeats = selectedSeats.filter(seat => seat.id !== seatId);
                } else {
                    // Chọn ghế
                    $(this).addClass('selected');
                    selectedSeats.push({ id: seatId, position: seatPosition });
                }
                
                updateBookingInfo();
            });
            
            // Xóa tất cả ghế đã chọn
            $('#clearSeats').click(function() {
                selectedSeats.forEach(seat => {
                    $(`.seat[data-seat-id="${seat.id}"]`).removeClass('selected');
                });
                selectedSeats = [];
                updateBookingInfo();
            });
            
            // Xóa từng ghế đã chọn
            $('#selectedSeatList').on('click', '.remove-seat', function() {
                let seatId = $(this).data('seat-id');
                $(`.seat[data-seat-id="${seatId}"]`).removeClass('selected');
                selectedSeats = selectedSeats.filter(seat => seat.id !== seatId);
                updateBookingInfo();
            });
            
            // Cập nhật thông tin đặt chỗ
            function updateBookingInfo() {
                if (selectedSeats.length > 0) {
                    $('#selectedSeats').text(selectedSeats.length + ' ghế');
                    $('#clearSeats').show();
                    
                    let html = '';
                    selectedSeats.forEach(seat => {
                        html += `<li class="list-inline-item">
                            <span class="badge bg-warning text-dark">
                                ${seat.position}
                                <button type="button" class="btn-close btn-close-white ms-1 remove-seat" 
                                        data-seat-id="${seat.id}" aria-label="Close"></button>
                            </span>
                        </li>`;
                    });
                    $('#selectedSeatList').html(html);
                } else {
                    $('#selectedSeats').text('Chưa chọn ghế');
                    $('#clearSeats').hide();
                    $('#selectedSeatList').empty();
                }
                
                $('#seatCount').text(selectedSeats.length);
                
                // Tính tổng tiền
                let total = 0;
                selectedSeats.forEach(seat => {
                    let seatElement = $(`.seat[data-seat-id="${seat.id}"]`);
                    if (seatElement.hasClass('vip')) {
                        total += vipPrice;
                    } else if (seatElement.hasClass('couple')) {
                        total += couplePrice;
                    } else {
                        total += regularPrice;
                    }
                });
                $('#totalPrice').text(total.toLocaleString());
                
                // Kích hoạt/vô hiệu hóa nút tiếp tục
                $('#btnContinue').prop('disabled', selectedSeats.length === 0);
            }
            
            // Xử lý nút tiếp tục
            $('#btnContinue').click(function() {
                if (selectedSeats.length > 0) {
                    let seatIds = selectedSeats.map(seat => seat.id);
                    window.location.href = '@Url.Action("Checkout", "StaffBooking")?showtimeId=@ViewBag.Showtime?.ShowtimeId&seatIds=' + seatIds.join(',');
                }
            });
        });
    </script>
}