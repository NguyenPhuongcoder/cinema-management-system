@{
    ViewData["Title"] = "Thanh toán - Đặt vé";
    Layout = "_Layout";
}

<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="mb-0">Thanh toán</h4>
                <a asp-controller="StaffBooking" asp-action="SelectSeats" asp-route-showtimeId="@ViewBag.Showtime?.ShowtimeId" class="btn btn-sm btn-light">
                    <i class="fas fa-arrow-left"></i> Quay lại
                </a>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <!-- Form thanh toán -->
                    <form id="checkoutForm" method="post" asp-action="ProcessBooking">
                        <input type="hidden" name="showtimeId" value="@ViewBag.Showtime?.ShowtimeId" />
                        @if (ViewBag.SeatIds != null)
                        {
                            foreach (var seatId in ViewBag.SeatIds)
                            {
                                <input type="hidden" name="seatIds" value="@seatId" />
                            }
                        }
                        else
                        {
                            <div class="alert alert-danger">
                                Không có thông tin ghế được chọn. Vui lòng quay lại và chọn ghế.
                            </div>
                        }
                        
                        <!-- Thông tin khách hàng -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Thông tin khách hàng</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="fullName">Họ và tên <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="fullName" name="fullName" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="phone">Số điện thoại <span class="text-danger">*</span></label>
                                        <input type="tel" class="form-control" id="phone" name="phone" required pattern="[0-9]{10}">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="email">Email</label>
                                        <input type="email" class="form-control" id="email" name="email">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="userId">Mã thành viên</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="userId" name="userId">
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary" type="button" id="checkMember">Kiểm tra</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Phương thức thanh toán -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Phương thức thanh toán</h5>
                            </div>
                            <div class="card-body">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="paymentMethod" id="cash" value="cash" checked>
                                    <label class="form-check-label" for="cash">
                                        Tiền mặt
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="paymentMethod" id="card" value="card">
                                    <label class="form-check-label" for="card">
                                        Thẻ tín dụng/ghi nợ
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="paymentMethod" id="transfer" value="transfer">
                                    <label class="form-check-label" for="transfer">
                                        Chuyển khoản
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Mã giảm giá -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Mã giảm giá</h5>
                            </div>
                            <div class="card-body">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="discountCode" placeholder="Nhập mã giảm giá">
                                    <div class="input-group-append">
                                        <button class="btn btn-outline-primary" type="button" id="applyDiscount">Áp dụng</button>
                                    </div>
                                </div>
                                <input type="hidden" id="discountId" name="discountId">
                                <div id="discountMessage" class="mt-2"></div>
                            </div>
                        </div>

                        <!-- Ghi chú -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Ghi chú</h5>
                            </div>
                            <div class="card-body">
                                <textarea class="form-control" id="note" name="note" rows="3" placeholder="Nhập ghi chú về đơn hàng nếu cần"></textarea>
                            </div>
                        </div>

                        <div class="text-center">
                            <button type="submit" class="btn btn-primary btn-lg">Hoàn tất đặt vé</button>
                        </div>
                    </form>
                </div>

                <div class="col-md-4">
                    <!-- Tóm tắt đơn hàng -->
                    <div class="card">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Tóm tắt đơn hàng</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <h6>@ViewBag.Showtime?.Movie?.Title</h6>
                                <p class="mb-1 text-muted">@ViewBag.Showtime?.Room?.Cinema?.Name - @ViewBag.Showtime?.Room?.Name</p>
                                <p class="mb-1 text-muted">@ViewBag.Showtime?.StartTime.ToString("dd/MM/yyyy - HH:mm")</p>
                                <p class="mb-1 text-muted">Định dạng: @ViewBag.Showtime?.Room?.Format?.Name</p>
                            </div>
                            <hr>
                            <div class="mb-3">
                                <h6>Ghế đã chọn</h6>
                                <p class="mb-1">
                                    @{
                                        var selectedSeats = ViewBag.SelectedSeats as List<Seat>;
                                        if (selectedSeats != null)
                                        {
                                            var seatGroups = selectedSeats
                                                .GroupBy(s => s.SeatType?.TypeName)
                                                .Select(g => $"{string.Join(", ", g.Select(s => s.RowLetter + s.SeatNumber))} ({g.Key})");
                                            @string.Join(" | ", seatGroups)
                                        }
                                    }
                                </p>
                            </div>
                            <hr>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between">
                                    <span>Tổng tiền vé:</span>
                                    <span>@ViewBag.TotalAmount.ToString("N0") VND</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>Phí dịch vụ:</span>
                                    <span>15.000 VND</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>Giảm giá:</span>
                                    <span id="discountAmount">0 VND</span>
                                </div>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between">
                                <h5>Tổng thanh toán:</h5>
                                <h5 class="text-primary" id="finalAmount">@((ViewBag.TotalAmount + 15000).ToString("N0")) VND</h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Xử lý kiểm tra mã giảm giá
            $('#applyDiscount').click(function() {
                const code = $('#discountCode').val();
                if (!code) {
                    $('#discountMessage').html('<div class="alert alert-warning">Vui lòng nhập mã giảm giá</div>');
                    return;
                }

                $.get('@Url.Action("CheckDiscount", "StaffBooking")', { code: code }, function(response) {
                    if (response.success) {
                        $('#discountMessage').html('<div class="alert alert-success">Áp dụng mã giảm giá thành công</div>');
                        $('#discountId').val(response.discountId);
                        // Cập nhật tổng tiền sau khi áp dụng giảm giá
                        updateTotalAmount(response.discountAmount);
                    } else {
                        $('#discountMessage').html('<div class="alert alert-danger">' + response.message + '</div>');
                        $('#discountId').val('');
                    }
                });
            });

            // Xử lý kiểm tra thành viên
            $('#checkMember').click(function() {
                const userId = $('#userId').val();
                if (!userId) {
                    alert('Vui lòng nhập mã thành viên');
                    return;
                }

                $.get('@Url.Action("CheckMember", "StaffBooking")', { userId: userId }, function(response) {
                    if (response.success) {
                        $('#fullName').val(response.user.fullName);
                        $('#phone').val(response.user.phone);
                        $('#email').val(response.user.email);
                        alert('Thông tin thành viên đã được cập nhật');
                    } else {
                        alert(response.message || 'Không tìm thấy thông tin thành viên');
                    }
                });
            });

            // Xử lý submit form
            $('#checkoutForm').submit(function(e) {
                e.preventDefault();
                
                // Kiểm tra các trường bắt buộc
                const fullName = $('#fullName').val();
                const phone = $('#phone').val();
                
                if (!fullName || !phone) {
                    alert('Vui lòng điền đầy đủ thông tin bắt buộc');
                    return;
                }

                // Submit form nếu hợp lệ
                this.submit();
            });
        });

        function updateTotalAmount(discountAmount) {
            const baseAmount = @ViewBag.TotalAmount;
            const serviceFee = 15000;
            const total = baseAmount + serviceFee - discountAmount;
            
            $('#discountAmount').text(discountAmount.toLocaleString() + ' VND');
            $('#finalAmount').text(total.toLocaleString() + ' VND');
        }
    </script>
} 